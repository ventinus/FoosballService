"use strict";
const assert_1 = require("@aws-cdk/assert");
const cdk = require("@aws-cdk/core");
const apigateway = require("../lib");
const RESOURCE_TYPE = 'AWS::ApiGateway::UsagePlan';
module.exports = {
    'default setup'(test) {
        // GIVEN
        const stack = new cdk.Stack();
        const api = new apigateway.RestApi(stack, 'my-api', { cloudWatchRole: false, deploy: false });
        api.root.addMethod('GET'); // Need at least one method on the api
        const usagePlanName = 'Pro';
        const usagePlanDescription = 'Pro Usage Plan with no throttling limits';
        // WHEN
        new apigateway.UsagePlan(stack, 'my-usage-plan', {
            name: usagePlanName,
            description: usagePlanDescription
        });
        // THEN
        assert_1.expect(stack).to(assert_1.haveResource(RESOURCE_TYPE, {
            UsagePlanName: usagePlanName,
            Description: usagePlanDescription
        }, assert_1.ResourcePart.Properties));
        test.done();
    },
    'usage plan with throttling limits'(test) {
        // GIVEN
        const stack = new cdk.Stack();
        const api = new apigateway.RestApi(stack, 'my-api', { cloudWatchRole: false, deploy: true, deployOptions: { stageName: 'test' } });
        const method = api.root.addMethod('GET'); // Need at least one method on the api
        const usagePlanName = 'Basic';
        const usagePlanDescription = 'Basic Usage Plan with no throttling limits';
        // WHEN
        new apigateway.UsagePlan(stack, 'my-usage-plan', {
            name: usagePlanName,
            description: usagePlanDescription,
            apiStages: [
                {
                    stage: api.deploymentStage,
                    throttle: [
                        {
                            method,
                            throttle: {
                                burstLimit: 20,
                                rateLimit: 10
                            }
                        }
                    ]
                }
            ]
        });
        // THEN
        assert_1.expect(stack).to(assert_1.haveResource(RESOURCE_TYPE, {
            UsagePlanName: usagePlanName,
            Description: usagePlanDescription,
            ApiStages: [
                {
                    ApiId: {
                        Ref: 'myapi4C7BF186'
                    },
                    Stage: {
                        Ref: 'myapiDeploymentStagetest4A4AB65E'
                    },
                    Throttle: {
                        '//GET': {
                            BurstLimit: 20,
                            RateLimit: 10
                        }
                    }
                }
            ]
        }, assert_1.ResourcePart.Properties));
        test.done();
    },
    'usage plan with quota limits'(test) {
        // GIVEN
        const stack = new cdk.Stack();
        // WHEN
        new apigateway.UsagePlan(stack, 'my-usage-plan', {
            quota: {
                limit: 10000,
                period: apigateway.Period.MONTH
            }
        });
        // THEN
        assert_1.expect(stack).to(assert_1.haveResource(RESOURCE_TYPE, {
            Quota: {
                Limit: 10000,
                Period: 'MONTH'
            }
        }, assert_1.ResourcePart.Properties));
        test.done();
    },
    'UsagePlanKey'(test) {
        // GIVEN
        const stack = new cdk.Stack();
        const usagePlan = new apigateway.UsagePlan(stack, 'my-usage-plan', {
            name: 'Basic',
        });
        const apiKey = new apigateway.ApiKey(stack, 'my-api-key');
        // WHEN
        usagePlan.addApiKey(apiKey);
        // THEN
        assert_1.expect(stack).to(assert_1.haveResource('AWS::ApiGateway::UsagePlanKey', {
            KeyId: {
                Ref: 'myapikey1B052F70'
            },
            KeyType: 'API_KEY',
            UsagePlanId: {
                Ref: 'myusageplan23AA1E32'
            }
        }, assert_1.ResourcePart.Properties));
        test.done();
    },
    'UsagePlan can have multiple keys'(test) {
        // GIVEN
        const stack = new cdk.Stack();
        const usagePlan = new apigateway.UsagePlan(stack, 'my-usage-plan');
        const apiKey1 = new apigateway.ApiKey(stack, 'my-api-key-1', {
            apiKeyName: 'my-api-key-1'
        });
        const apiKey2 = new apigateway.ApiKey(stack, 'my-api-key-2', {
            apiKeyName: 'my-api-key-2'
        });
        // WHEN
        usagePlan.addApiKey(apiKey1);
        usagePlan.addApiKey(apiKey2);
        // THEN
        assert_1.expect(stack).to(assert_1.haveResource('AWS::ApiGateway::ApiKey', {
            Name: 'my-api-key-1'
        }, assert_1.ResourcePart.Properties));
        assert_1.expect(stack).to(assert_1.haveResource('AWS::ApiGateway::ApiKey', {
            Name: 'my-api-key-2'
        }, assert_1.ResourcePart.Properties));
        assert_1.expect(stack).to(assert_1.haveResource('AWS::ApiGateway::UsagePlanKey', {
            KeyId: {
                Ref: 'myapikey11F723FC7'
            }
        }, assert_1.ResourcePart.Properties));
        assert_1.expect(stack).to(assert_1.haveResource('AWS::ApiGateway::UsagePlanKey', {
            KeyId: {
                Ref: 'myapikey2ABDEF012'
            }
        }, assert_1.ResourcePart.Properties));
        test.done();
    },
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGVzdC51c2FnZS1wbGFuLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsidGVzdC51c2FnZS1wbGFuLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSw0Q0FBcUU7QUFDckUscUNBQXNDO0FBRXRDLHFDQUFzQztBQUV0QyxNQUFNLGFBQWEsR0FBRyw0QkFBNEIsQ0FBQztBQUNuRCxpQkFBUztJQUNQLGVBQWUsQ0FBQyxJQUFVO1FBQ3hCLFFBQVE7UUFDUixNQUFNLEtBQUssR0FBRyxJQUFJLEdBQUcsQ0FBQyxLQUFLLEVBQUUsQ0FBQztRQUM5QixNQUFNLEdBQUcsR0FBRyxJQUFJLFVBQVUsQ0FBQyxPQUFPLENBQUMsS0FBSyxFQUFFLFFBQVEsRUFBRSxFQUFFLGNBQWMsRUFBRSxLQUFLLEVBQUUsTUFBTSxFQUFFLEtBQUssRUFBRSxDQUFDLENBQUM7UUFDOUYsR0FBRyxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxzQ0FBc0M7UUFDakUsTUFBTSxhQUFhLEdBQUcsS0FBSyxDQUFDO1FBQzVCLE1BQU0sb0JBQW9CLEdBQUcsMENBQTBDLENBQUM7UUFFeEUsT0FBTztRQUNQLElBQUksVUFBVSxDQUFDLFNBQVMsQ0FBQyxLQUFLLEVBQUUsZUFBZSxFQUFFO1lBQy9DLElBQUksRUFBRSxhQUFhO1lBQ25CLFdBQVcsRUFBRSxvQkFBb0I7U0FDbEMsQ0FBQyxDQUFDO1FBRUgsT0FBTztRQUNQLGVBQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQyxFQUFFLENBQUMscUJBQVksQ0FBQyxhQUFhLEVBQUU7WUFDM0MsYUFBYSxFQUFFLGFBQWE7WUFDNUIsV0FBVyxFQUFFLG9CQUFvQjtTQUNsQyxFQUFFLHFCQUFZLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQztRQUU3QixJQUFJLENBQUMsSUFBSSxFQUFFLENBQUM7SUFDZCxDQUFDO0lBRUQsbUNBQW1DLENBQUMsSUFBVTtRQUM1QyxRQUFRO1FBQ1IsTUFBTSxLQUFLLEdBQUcs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WSxDQUFDLHlCQUF5QixFQUFFO1lBQ3ZELElBQUksRUFBRSxjQUFjO1NBQ3JCLEVBQUUscUJBQVksQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDO1FBQzdCLGVBQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQyxFQUFFLENBQUMscUJBQVksQ0FBQywrQkFBK0IsRUFBRTtZQUM3RCxLQUFLLEVBQUU7Z0JBQ0wsR0FBRyxFQUFFLG1CQUFtQjthQUN6QjtTQUNGLEVBQUUscUJBQVksQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDO1FBQzdCLGVBQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQyxFQUFFLENBQUMscUJBQVksQ0FBQywrQkFBK0IsRUFBRTtZQUM3RCxLQUFLLEVBQUU7Z0JBQ0wsR0FBRyxFQUFFLG1CQUFtQjthQUN6QjtTQUNGLEVBQUUscUJBQVksQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDO1FBRTdCLElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQztJQUNkLENBQUM7Q0FDRixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgZXhwZWN0LCBoYXZlUmVzb3VyY2UsIFJlc291cmNlUGFydCB9IGZyb20gJ0Bhd3MtY2RrL2Fzc2VydCc7XG5pbXBvcnQgY2RrID0gcmVxdWlyZSgnQGF3cy1jZGsvY29yZScpO1xuaW1wb3J0IHsgVGVzdCB9IGZyb20gXCJub2RldW5pdFwiO1xuaW1wb3J0IGFwaWdhdGV3YXkgPSByZXF1aXJlKCcuLi9saWInKTtcblxuY29uc3QgUkVTT1VSQ0VfVFlQRSA9ICdBV1M6OkFwaUdhdGV3YXk6OlVzYWdlUGxhbic7XG5leHBvcnQgPSB7XG4gICdkZWZhdWx0IHNldHVwJyh0ZXN0OiBUZXN0KSB7XG4gICAgLy8gR0lWRU5cbiAgICBjb25zdCBzdGFjayA9IG5ldyBjZGsuU3RhY2soKTtcbiAgICBjb25zdCBhcGkgPSBuZXcgYXBpZ2F0ZXdheS5SZXN0QXBpKHN0YWNrLCAnbXktYXBpJywgeyBjbG91ZFdhdGNoUm9sZTogZmFsc2UsIGRlcGxveTogZmFsc2UgfSk7XG4gICAgYXBpLnJvb3QuYWRkTWV0aG9kKCdHRVQnKTsgLy8gTmVlZCBhdCBsZWFzdCBvbmUgbWV0aG9kIG9uIHRoZSBhcGlcbiAgICBjb25zdCB1c2FnZVBsYW5OYW1lID0gJ1Bybyc7XG4gICAgY29uc3QgdXNhZ2VQbGFuRGVzY3JpcHRpb24gPSAnUHJvIFVzYWdlIFBsYW4gd2l0aCBubyB0aHJvdHRsaW5nIGxpbWl0cyc7XG5cbiAgICAvLyBXSEVOXG4gICAgbmV3IGFwaWdhdGV3YXkuVXNhZ2VQbGFuKHN0YWNrLCAnbXktdXNhZ2UtcGxhbicsIHtcbiAgICAgIG5hbWU6IHVzYWdlUGxhbk5hbWUsXG4gICAgICBkZXNjcmlwdGlvbjogdXNhZ2VQbGFuRGVzY3JpcHRpb25cbiAgICB9KTtcblxuICAgIC8vIFRIRU5cbiAgICBleHBlY3Qoc3RhY2spLnRvKGhhdmVSZXNvdXJjZShSRVNPVVJDRV9UWVBFLCB7XG4gICAgICBVc2FnZVBsYW5OYW1lOiB1c2FnZVBsYW5OYW1lLFxuICAgICAgRGVzY3JpcHRpb246IHVzYWdlUGxhbkRlc2NyaXB0aW9uXG4gICAgfSwgUmVzb3VyY2VQYXJ0LlByb3BlcnRpZXMpKTtcblxuICAgIHRlc3QuZG9uZSgpO1xuICB9LFxuXG4gICd1c2FnZSBwbGFuIHdpdGggdGhyb3R0bGluZyBsaW1pdHMnKHRlc3Q6IFRlc3QpIHtcbiAgICAvLyBHSVZFTlxuICAgIGNvbnN0IHN0YWNrID0gbmV3IGNkay5TdGFjaygpO1xuICAgIGNvbnN0IGFwaSA9IG5ldyBhcGlnYXRld2F5LlJlc3RBcGkoc3RhY2ssICdteS1hcGknLCB7IGNsb3VkV2F0Y2hSb2xlOiBmYWxzZSwgZGVwbG95OiB0cnVlLCBkZXBsb3lPcHRpb25zOiB7IHN0YWdlTmFtZTogJ3Rlc3QnIH0gfSk7XG4gICAgY29uc3QgbWV0aG9kOiBhcGlnYXRld2F5Lk1ldGhvZCA9IGFwaS5yb290LmFkZE1ldGhvZCgnR0VUJyk7IC8vIE5lZWQgYXQgbGVhc3Qgb25lIG1ldGhvZCBvbiB0aGUgYXBpXG4gICAgY29uc3QgdXNhZ2VQbGFuTmFtZSA9ICdCYXNpYyc7XG4gICAgY29uc3QgdXNhZ2VQbGFuRGVzY3JpcHRpb24gPSAnQmFzaWMgVXNhZ2UgUGxhbiB3aXRoIG5vIHRocm90dGxpbmcgbGltaXRzJztcblxuICAgIC8vIFdIRU5cbiAgICBuZXcgYXBpZ2F0ZXdheS5Vc2FnZVBsYW4oc3RhY2ssICdteS11c2FnZS1wbGFuJywge1xuICAgICAgbmFtZTogdXNhZ2VQbGFuTmFtZSxcbiAgICAgIGRlc2NyaXB0aW9uOiB1c2FnZVBsYW5EZXNjcmlwdGlvbixcbiAgICAgIGFwaVN0YWdlczogW1xuICAgICAgICB7XG4gICAgICAgICAgc3RhZ2U6IGFwaS5kZXBsb3ltZW50U3RhZ2UsXG4gICAgICAgICAgdGhyb3R0bGU6IFtcbiAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgbWV0aG9kLFxuICAgICAgICAgICAgICB0aHJvdHRsZToge1xuICAgICAgICAgICAgICAgIGJ1cnN0TGltaXQ6IDIwLFxuICAgICAgICAgICAgICAgIHJhdGVMaW1pdDogMTBcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgIF1cbiAgICAgICAgfVxuICAgICAgXVxuICAgIH0pO1xuXG4gICAgLy8gVEhFTlxuICAgIGV4cGVjdChzdGFjaykudG8oaGF2ZVJlc291cmNlKFJFU09VUkNFX1RZUEUsIHtcbiAgICAgIFVzYWdlUGxhbk5hbWU6IHVzYWdlUGxhbk5hbWUsXG4gICAgICBEZXNjcmlwdGlvbjogdXNhZ2VQbGFuRGVzY3JpcHRpb24sXG4gICAgICBBcGlTdGFnZXM6IFtcbiAgICAgICAge1xuICAgICAgICAgIEFwaUlkOiB7XG4gICAgICAgICAgICBSZWY6ICdteWFwaTRDN0JGMTg2J1xuICAgICAgICAgIH0sXG4gICAgICAgICAgU3RhZ2U6IHtcbiAgICAgICAgICAgIFJlZjogJ215YXBpRGVwbG95bWVudFN0YWdldGVzdDRBNEFCNjVFJ1xuICAgICAgICAgIH0sXG4gICAgICAgICAgVGhyb3R0bGU6IHtcbiAgICAgICAgICAgICcvL0dFVCc6IHtcbiAgICAgICAgICAgICAgQnVyc3RMaW1pdDogMjAsXG4gICAgICAgICAgICAgIFJhdGVMaW1pdDogMTBcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIF1cbiAgICB9LCBSZXNvdXJjZVBhcnQuUHJvcGVydGllcykpO1xuXG4gICAgdGVzdC5kb25lKCk7XG5cbiAgfSxcblxuICAndXNhZ2UgcGxhbiB3aXRoIHF1b3RhIGxpbWl0cycodGVzdDogVGVzdCkge1xuICAgIC8vIEdJVkVOXG4gICAgY29uc3Qgc3RhY2sgPSBuZXcgY2RrLlN0YWNrKCk7XG5cbiAgICAvLyBXSEVOXG4gICAgbmV3IGFwaWdhdGV3YXkuVXNhZ2VQbGFuKHN0YWNrLCAnbXktdXNhZ2UtcGxhbicsIHtcbiAgICAgIHF1b3RhOiB7XG4gICAgICAgIGxpbWl0OiAxMDAwMCxcbiAgICAgICAgcGVyaW9kOiBhcGlnYXRld2F5LlBlcmlvZC5NT05USFxuICAgICAgfVxuICAgIH0pO1xuXG4gICAgLy8gVEhFTlxuICAgIGV4cGVjdChzdGFjaykudG8oaGF2ZVJlc291cmNlKFJFU09VUkNFX1RZUEUsIHtcbiAgICAgIFF1b3RhOiB7XG4gICAgICAgIExpbWl0OiAxMDAwMCxcbiAgICAgICAgUGVyaW9kOiAnTU9OVEgnXG4gICAgICB9XG4gICAgfSwgUmVzb3VyY2VQYXJ0LlByb3BlcnRpZXMpKTtcblxuICAgIHRlc3QuZG9uZSgpO1xuXG4gIH0sXG5cbiAgJ1VzYWdlUGxhbktleScodGVzdDogVGVzdCkge1xuICAgIC8vIEdJVkVOXG4gICAgY29uc3Qgc3RhY2sgPSBuZXcgY2RrLlN0YWNrKCk7XG4gICAgY29uc3QgdXNhZ2VQbGFuOiBhcGlnYXRld2F5LlVzYWdlUGxhbiA9IG5ldyBhcGlnYXRld2F5LlVzYWdlUGxhbihzdGFjaywgJ215LXVzYWdlLXBsYW4nLCB7XG4gICAgICBuYW1lOiAnQmFzaWMnLFxuICAgIH0pO1xuICAgIGNvbnN0IGFwaUtleTogYXBpZ2F0ZXdheS5BcGlLZXkgPSBuZXcgYXBpZ2F0ZXdheS5BcGlLZXkoc3RhY2ssICdteS1hcGkta2V5Jyk7XG5cbiAgICAvLyBXSEVOXG4gICAgdXNhZ2VQbGFuLmFkZEFwaUtleShhcGlLZXkpO1xuXG4gICAgLy8gVEhFTlxuICAgIGV4cGVjdChzdGFjaykudG8oaGF2ZVJlc291cmNlKCdBV1M6OkFwaUdhdGV3YXk6OlVzYWdlUGxhbktleScsIHtcbiAgICAgIEtleUlkOiB7XG4gICAgICAgIFJlZjogJ215YXBpa2V5MUIwNTJGNzAnXG4gICAgICB9LFxuICAgICAgS2V5VHlwZTogJ0FQSV9LRVknLFxuICAgICAgVXNhZ2VQbGFuSWQ6IHtcbiAgICAgICAgUmVmOiAnbXl1c2FnZXBsYW4yM0FBMUUzMidcbiAgICAgIH1cbiAgICB9LCBSZXNvdXJjZVBhcnQuUHJvcGVydGllcykpO1xuXG4gICAgdGVzdC5kb25lKCk7XG4gIH0sXG5cbiAgJ1VzYWdlUGxhbiBjYW4gaGF2ZSBtdWx0aXBsZSBrZXlzJyh0ZXN0OiBUZXN0KSB7XG4gICAgLy8gR0lWRU5cbiAgICBjb25zdCBzdGFjayA9IG5ldyBjZGsuU3RhY2soKTtcbiAgICBjb25zdCB1c2FnZVBsYW4gPSBuZXcgYXBpZ2F0ZXdheS5Vc2FnZVBsYW4oc3RhY2ssICdteS11c2FnZS1wbGFuJyk7XG4gICAgY29uc3QgYXBpS2V5MSA9IG5ldyBhcGlnYXRld2F5LkFwaUtleShzdGFjaywgJ215LWFwaS1rZXktMScsIHtcbiAgICAgIGFwaUtleU5hbWU6ICdteS1hcGkta2V5LTEnXG4gICAgfSk7XG4gICAgY29uc3QgYXBpS2V5MiA9IG5ldyBhcGlnYXRld2F5LkFwaUtleShzdGFjaywgJ215LWFwaS1rZXktMicsIHtcbiAgICAgIGFwaUtleU5hbWU6ICdteS1hcGkta2V5LTInXG4gICAgfSk7XG5cbiAgICAvLyBXSEVOXG4gICAgdXNhZ2VQbGFuLmFkZEFwaUtleShhcGlLZXkxKTtcbiAgICB1c2FnZVBsYW4uYWRkQXBpS2V5KGFwaUtleTIpO1xuXG4gICAgLy8gVEhFTlxuICAgIGV4cGVjdChzdGFjaykudG8oaGF2ZVJlc291cmNlKCdBV1M6OkFwaUdhdGV3YXk6OkFwaUtleScsIHtcbiAgICAgIE5hbWU6ICdteS1hcGkta2V5LTEnXG4gICAgfSwgUmVzb3VyY2VQYXJ0LlByb3BlcnRpZXMpKTtcbiAgICBleHBlY3Qoc3RhY2spLnRvKGhhdmVSZXNvdXJjZSgnQVdTOjpBcGlHYXRld2F5OjpBcGlLZXknLCB7XG4gICAgICBOYW1lOiAnbXktYXBpLWtleS0yJ1xuICAgIH0sIFJlc291cmNlUGFydC5Qcm9wZXJ0aWVzKSk7XG4gICAgZXhwZWN0KHN0YWNrKS50byhoYXZlUmVzb3VyY2UoJ0FXUzo6QXBpR2F0ZXdheTo6VXNhZ2VQbGFuS2V5Jywge1xuICAgICAgS2V5SWQ6IHtcbiAgICAgICAgUmVmOiAnbXlhcGlrZXkxMUY3MjNGQzcnXG4gICAgICB9XG4gICAgfSwgUmVzb3VyY2VQYXJ0LlByb3BlcnRpZXMpKTtcbiAgICBleHBlY3Qoc3RhY2spLnRvKGhhdmVSZXNvdXJjZSgnQVdTOjpBcGlHYXRld2F5OjpVc2FnZVBsYW5LZXknLCB7XG4gICAgICBLZXlJZDoge1xuICAgICAgICBSZWY6ICdteWFwaWtleTJBQkRFRjAxMidcbiAgICAgIH1cbiAgICB9LCBSZXNvdXJjZVBhcnQuUHJvcGVydGllcykpO1xuXG4gICAgdGVzdC5kb25lKCk7XG4gIH0sXG59O1xuIl19