"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const lambda = require("@aws-cdk/aws-lambda");
const sns = require("@aws-cdk/aws-sns");
const sns_subscriptions = require("@aws-cdk/aws-sns-subscriptions");
const sqs = require("@aws-cdk/aws-sqs");
const core_1 = require("@aws-cdk/core");
const cfn = require("../lib");
class MyNestedStack extends cfn.NestedStack {
    constructor(scope, id, props) {
        const topicNamePrefixLogicalId = 'TopicNamePrefix';
        super(scope, id, {
            parameters: {
                [topicNamePrefixLogicalId]: props.topicNamePrefix // pass in a parameter to the nested stack
            }
        });
        const topicNamePrefixParameter = new core_1.CfnParameter(this, 'TopicNamePrefix', { type: 'String' });
        for (let i = 0; i < props.topicCount; ++i) {
            const topic = new sns.Topic(this, `topic-${i}`, { displayName: `${topicNamePrefixParameter.valueAsString}-${i}` });
            // since the subscription resources are defined in the subscriber's stack, this
            // will add an SNS subscription resource to the parent stack that reference this topic.
            if (props.subscriber) {
                topic.addSubscription(new sns_subscriptions.SqsSubscription(props.subscriber));
            }
        }
        if (props.subscriber) {
            new lambda.Function(this, 'fn', {
                runtime: lambda.Runtime.NODEJS_8_10,
                code: lambda.Code.inline('console.error("hi")'),
                handler: 'index.handler',
                environment: {
                    TOPIC_ARN: props.siblingTopic ? props.siblingTopic.topicArn : '',
                    QUEUE_URL: props.subscriber.queueUrl // nested stack references a resource in the parent
                }
            });
        }
    }
}
class MyTestStack extends core_1.Stack {
    constructor(scope, id) {
        super(scope, id);
        const queue = new sqs.Queue(this, 'SubscriberQueue');
        new MyNestedStack(this, 'NestedStack1', { topicCount: 3, topicNamePrefix: 'Prefix1', subscriber: queue });
        new MyNestedStack(this, 'NestedStack2', { topicCount: 2, topicNamePrefix: 'Prefix2' });
    }
}
const app = new core_1.App();
new MyTestStack(app, 'nested-stacks-test');
app.synth();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW50ZWcubmVzdGVkLXN0YWNrLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiaW50ZWcubmVzdGVkLXN0YWNrLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsOENBQStDO0FBQy9DLHdDQUF5QztBQUN6QyxvRUFBcUU7QUFDckUsd0NBQXlDO0FBQ3pDLHdDQUFvRTtBQUNwRSw4QkFBK0I7QUFTL0IsTUFBTSxhQUFjLFNBQVEsR0FBRyxDQUFDLFdBQVc7SUFDekMsWUFBWSxLQUFnQixFQUFFLEVBQVUsRUFBRSxLQUF5QjtRQUNqRSxNQUFNLHdCQUF3QixHQUFHLGlCQUFpQixDQUFDO1FBRW5ELEtBQUssQ0FBQyxLQUFLLEVBQUUsRUFBRSxFQUFFO1lBQ2YsVUFBVSxFQUFFO2dCQUNWLENBQUMsd0JBQXdCLENBQUMsRUFBRSxLQUFLLENBQUMsZUFBZSxDQUFDLDBDQUEwQzthQUM3RjtTQUNGLENBQUMsQ0FBQztRQUVILE1BQU0sd0JBQXdCLEdBQUcsSUFBSSxtQkFBWSxDQUFDLElBQUksRUFBRSxpQkFBaUIsRUFBRSxFQUFFLElBQUksRUFBRSxRQUFRLEVBQUUsQ0FBQyxDQUFDO1FBRS9GLEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxLQUFLLENBQUMsVUFBVSxFQUFFLEVBQUUsQ0FBQyxFQUFFO1lBQ3pDLE1BQU0sS0FBSyxHQUFHLElBQUksR0FBRyxDQUFDLEtBQUssQ0FBQyxJQUFJLEVBQUUsU0FBUyxDQUFDLEVBQUUsRUFBRSxFQUFFLFdBQVcsRUFBRSxHQUFHLHdCQUF3QixDQUFDLGFBQWEsSUFBSSxDQUFDLEVBQUUsRUFBQyxDQUFDLENBQUM7WUFFbEgsK0VBQStFO1lBQy9FLHVGQUF1RjtZQUN2RixJQUFJLEtBQUssQ0FBQyxVQUFVLEVBQUU7Z0JBQ3BCLEtBQUssQ0FBQyxlQUFlLENBQUMsSUFBSSxpQkFBaUIsQ0FBQyxlQUFlLENBQUMsS0FBSyxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUM7YUFDaEY7U0FDRjtRQUVELElBQUksS0FBSyxDQUFDLFVBQVUsRUFBRTtZQUNwQixJQUFJLE1BQU0sQ0FBQyxRQUFRLENBQUMsSUFBSSxFQUFFLElBQUksRUFBRTtnQkFDOUIsT0FBTyxFQUFFLE1BQU0sQ0FBQyxPQUFPLENBQUMsV0FBVztnQkFDbkMsSUFBSSxFQUFFLE1BQU0sQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLHFCQUFxQixDQUFDO2dCQUMvQyxPQUFPLEVBQUUsZUFBZTtnQkFDeEIsV0FBVyxFQUFFO29CQUNYLFNBQVMsRUFBRSxLQUFLLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsWUFBWSxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsRUFBRTtvQkFDaEUsU0FBUyxFQUFFLEtBQUssQ0FBQyxVQUFVLENBQUMsUUFBUSxDQUFDLG1EQUFtRDtpQkFDekY7YUFDRixDQUFDLENBQUM7U0FDSjtJQUNILENBQUM7Q0FDRjtBQUVELE1BQU0sV0FBWSxTQUFRLFlBQUs7SUFDN0IsWUFBWSxLQUFnQixFQUFFLEVBQVU7UUFDdEMsS0FBSyxDQUFDLEtBQUssRUFBRSxFQUFFLENBQUMsQ0FBQztRQUVqQixNQUFNLEtBQUssR0FBRyxJQUFJLEdBQUcsQ0FBQyxLQUFLLENBQUMsSUFBSSxFQUFFLGlCQUFpQixDQUFDLENBQUM7UUFFckQsSUFBSSxhQUFhLENBQUMsSUFBSSxFQUFFLGNBQWMsRUFBRSxFQUFFLFVBQVUsRUFBRSxDQUFDLEVBQUUsZUFBZSxFQUFFLFNBQVMsRUFBRSxVQUFVLEVBQUUsS0FBSyxFQUFFLENBQUMsQ0FBQztRQUMxRyxJQUFJLGFBQWEsQ0FBQyxJQUFJLEVBQUUsY0FBYyxFQUFFLEVBQUUsVUFBVSxFQUFFLENBQUMsRUFBRSxlQUFlLEVBQUUsU0FBUyxFQUFFLENBQUMsQ0FBQztJQUN6RixDQUFDO0NBQ0Y7QUFFRCxNQUFNLEdBQUcsR0FBRyxJQUFJLFVBQUcsRUFBRSxDQUFDO0FBQ3RCLElBQUksV0FBVyxDQUFDLEdBQUcsRUFBRSxvQkFBb0IsQ0FBQyxDQUFDO0FBQzNDLEdBQUcsQ0FBQyxLQUFLLEVBQUUsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBsYW1iZGEgPSByZXF1aXJlKCdAYXdzLWNkay9hd3MtbGFtYmRhJyk7XG5pbXBvcnQgc25zID0gcmVxdWlyZSgnQGF3cy1jZGsvYXdzLXNucycpO1xuaW1wb3J0IHNuc19zdWJzY3JpcHRpb25zID0gcmVxdWlyZSgnQGF3cy1jZGsvYXdzLXNucy1zdWJzY3JpcHRpb25zJyk7XG5pbXBvcnQgc3FzID0gcmVxdWlyZSgnQGF3cy1jZGsvYXdzLXNxcycpO1xuaW1wb3J0IHsgQXBwLCBDZm5QYXJhbWV0ZXIsIENvbnN0cnVjdCwgU3RhY2sgfSBmcm9tICdAYXdzLWNkay9jb3JlJztcbmltcG9ydCBjZm4gPSByZXF1aXJlKCcuLi9saWInKTtcblxuaW50ZXJmYWNlIE15TmVzdGVkU3RhY2tQcm9wcyB7XG4gIHJlYWRvbmx5IHN1YnNjcmliZXI/OiBzcXMuUXVldWU7XG4gIHJlYWRvbmx5IHNpYmxpbmdUb3BpYz86IHNucy5Ub3BpYzsgLy8gYSB0b3BpYyBkZWZpbmVkIGluIGEgc2libGluZyBuZXN0ZWQgc3RhY2tcbiAgcmVhZG9ubHkgdG9waWNDb3VudDogbnVtYmVyO1xuICByZWFkb25seSB0b3BpY05hbWVQcmVmaXg6IHN0cmluZztcbn1cblxuY2xhc3MgTXlOZXN0ZWRTdGFjayBleHRlbmRzIGNmbi5OZXN0ZWRTdGFjayB7XG4gIGNvbnN0cnVjdG9yKHNjb3BlOiBDb25zdHJ1Y3QsIGlkOiBzdHJpbmcsIHByb3BzOiBNeU5lc3RlZFN0YWNrUHJvcHMpIHtcbiAgICBjb25zdCB0b3BpY05hbWVQcmVmaXhMb2dpY2FsSWQgPSAnVG9waWNOYW1lUHJlZml4JztcblxuICAgIHN1cGVyKHNjb3BlLCBpZCwge1xuICAgICAgcGFyYW1ldGVyczoge1xuICAgICAgICBbdG9waWNOYW1lUHJlZml4TG9naWNhbElkXTogcHJvcHMudG9waWNOYW1lUHJlZml4IC8vIHBhc3MgaW4gYSBwYXJhbWV0ZXIgdG8gdGhlIG5lc3RlZCBzdGFja1xuICAgICAgfVxuICAgIH0pO1xuXG4gICAgY29uc3QgdG9waWNOYW1lUHJlZml4UGFyYW1ldGVyID0gbmV3IENmblBhcmFtZXRlcih0aGlzLCAnVG9waWNOYW1lUHJlZml4JywgeyB0eXBlOiAnU3RyaW5nJyB9KTtcblxuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgcHJvcHMudG9waWNDb3VudDsgKytpKSB7XG4gICAgICBjb25zdCB0b3BpYyA9IG5ldyBzbnMuVG9waWModGhpcywgYHRvcGljLSR7aX1gLCB7IGRpc3BsYXlOYW1lOiBgJHt0b3BpY05hbWVQcmVmaXhQYXJhbWV0ZXIudmFsdWVBc1N0cmluZ30tJHtpfWB9KTtcblxuICAgICAgLy8gc2luY2UgdGhlIHN1YnNjcmlwdGlvbiByZXNvdXJjZXMgYXJlIGRlZmluZWQgaW4gdGhlIHN1YnNjcmliZXIncyBzdGFjaywgdGhpc1xuICAgICAgLy8gd2lsbCBhZGQgYW4gU05TIHN1YnNjcmlwdGlvbiByZXNvdXJjZSB0byB0aGUgcGFyZW50IHN0YWNrIHRoYXQgcmVmZXJlbmNlIHRoaXMgdG9waWMuXG4gICAgICBpZiAocHJvcHMuc3Vic2NyaWJlcikge1xuICAgICAgICB0b3BpYy5hZGRTdWJzY3JpcHRpb24obmV3IHNuc19zdWJzY3JpcHRpb25zLlNxc1N1YnNjcmlwdGlvbihwcm9wcy5zdWJzY3JpYmVyKSk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgaWYgKHByb3BzLnN1YnNjcmliZXIpIHtcbiAgICAgIG5ldyBsYW1iZGEuRnVuY3Rpb24odGhpcywgJ2ZuJywge1xuICAgICAgICBydW50aW1lOiBsYW1iZGEuUnVudGltZS5OT0RFSlNfOF8xMCxcbiAgICAgICAgY29kZTogbGFtYmRhLkNvZGUuaW5saW5lKCdjb25zb2xlLmVycm9yKFwiaGlcIiknKSxcbiAgICAgICAgaGFuZGxlcjogJ2luZGV4LmhhbmRsZXInLFxuICAgICAgICBlbnZpcm9ubWVudDoge1xuICAgICAgICAgIFRPUElDX0FSTjogcHJvcHMuc2libGluZ1RvcGljID8gcHJvcHMuc2libGluZ1RvcGljLnRvcGljQXJuIDogJycsXG4gICAgICAgICAgUVVFVUVfVVJMOiBwcm9wcy5zdWJzY3JpYmVyLnF1ZXVlVXJsIC8vIG5lc3RlZCBzdGFjayByZWZlcmVuY2VzIGEgcmVzb3VyY2UgaW4gdGhlIHBhcmVudFxuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9XG4gIH1cbn1cblxuY2xhc3MgTXlUZXN0U3RhY2sgZXh0ZW5kcyBTdGFjayB7XG4gIGNvbnN0cnVjdG9yKHNjb3BlOiBDb25zdHJ1Y3QsIGlkOiBzdHJpbmcpIHtcbiAgICBzdXBlcihzY29wZSwgaWQpO1xuXG4gICAgY29uc3QgcXVldWUgPSBuZXcgc3FzLlF1ZXVlKHRoaXMsICdTdWJzY3JpYmVyUXVldWUnKTtcblxuICAgIG5ldyBNeU5lc3RlZFN0YWNrKHRoaXMsICdOZXN0ZWRTdGFjazEnLCB7IHRvcGljQ291bnQ6IDMsIHRvcGljTmFtZVByZWZpeDogJ1ByZWZpeDEnLCBzdWJzY3JpYmVyOiBxdWV1ZSB9KTtcbiAgICBuZXcgTXlOZXN0ZWRTdGFjayh0aGlzLCAnTmVzdGVkU3RhY2syJywgeyB0b3BpY0NvdW50OiAyLCB0b3BpY05hbWVQcmVmaXg6ICdQcmVmaXgyJyB9KTtcbiAgfVxufVxuXG5jb25zdCBhcHAgPSBuZXcgQXBwKCk7XG5uZXcgTXlUZXN0U3RhY2soYXBwLCAnbmVzdGVkLXN0YWNrcy10ZXN0Jyk7XG5hcHAuc3ludGgoKTsiXX0=